# 동기화

---

## 동기화?
- 한정적인 시스템 자원에 여러 스레드가 동시에 접근해서 사용하면 문제가 발생할 수 있다.
- 이 문제를 방지하기 위해 여러 스레드에게 하나의 자원에 대한 처리 권한을 주거나 순서를 조정하는 기법이다.

## 스레드 동기화
- 실행 순서의 동기화
  - 스레드의 실행 순서를 정의하고, 이 순서를 반드시 따르도록 하는 것.
- 메모리 접근에 대한 동기화
  - 실행 순서가 중요한 것이 아니라 한 순간에 하나의 스레드만 해당 자원에 접근하도록 하는 것.

## 동기화 기법

### 1. 유저 모드의 동기화
- 커널의 힘을 빌리지 않는 동기화 기법
- 성능상 이점이 있으나, 기능상의 제한점이 존재

`임계 구역 기반의 동기화`
- `임계 구역(Critical Section)` 집입을 위해 `크리티컬 섹션 오브젝트`를 얻는다.
- 열쇠를 얻은 프로세스만 임계 구역에 들어갈 수 있다. 한번에 하나의 스레드만이 접근 가능하다.
- 다른 스레드가 열쇠를 가지고 있을 시에는 반환할 때까지 블로킹된다.
- 열쇠가 반환되면 블로킹 상태에서 빠져나와 열쇠를 얻고 임계 구역에 접근한다.

`인터락 함수 기반의 동기화`
- 인터락 함수: 함수 내부적으로 한 순간에 하나의 쓰레드에 의해서만 실행
- 임계 구역 기반의 동기화도 내부적으로 인터락 함수를 기반으로 구현된다.
- 유저 모드 기반으로 동작해서 속도가 빠르다.

### 2. 커널모드의 동기화
- 공유된 자원의 데이터를 여러 프로세스, 스레드가 접근하는 것을 막는 것이다.

#### 2-1. 세마포어(Semaphore)
- 동시에 접근할 수 있는 '허용 가능한 갯수'를 가지고 있는 Counter
  - 공유자원에 접근할 수 있는 스레드 혹은 프로세스의 수를 나타내는 값 -> 공통으로 관리하는 하나의 값
- 세마포어 Counter의 갯수에 따라 다음과 같이 나뉜다.
  - 1개: Binary Semaphore(뮤텍스와 같다.)
  - 2개 이상: Counting Semaphore
- 세마포어는 소유할 수 없다.
  - 세마포어를 소유하지 않는 스레드가 세마포어를 해제할 수 있는 문제가 발생한다.
- Counter라는 변수값으로 프로그래머가 상호 배제나 정렬의 목적으로 사용시 매번 값을 따로 지정해줘야하는 번거로움이 있다.

ex) 세마포어는 1개 이상의 열쇠라고 할 수 있다. 예로, 화장실 칸이 4개이고 열쇠가 4개라면, 4명까지는 대기없이 바로 사용할 수 있다. 그 다음부터는 대기를 해야한다.

#### 2-2. 뮤텍스(Mutal Exclusion)
- 임계 구역을 가진 스레드들의 Running time이 서로 겹치지 않게 각각 단독으로 실행되게 하는 기술
- 뮤텍스 객체를 두 스레드가 동시에 사용할 수 없다.
- 일종의 Locking 메커니즘으로 공유 자원에 대한 접근을 조율하기 위해 locking과 unlocking을 사용
- Lock에 대한 소유권이 있으며 Lock을 가지고 있을 경우에만 공유 자원에 접근할 수 있고, Lock을 가진 사람만 반납할 수 있다.
- 운영체제 커널에 의햇 제공되므로 무겁고 느리다.

ex) 뮤텍스는 무조건 1개의 열쇠만 가질수 있다. 열쇠를 가진 사람만이 화장실에 갈 수 있고, 다음 사람이 화장실을 가기 위해서는 앞 사람이 열쇠를 반납해야 한다.

#### 2-3. 모니터(Monitor)
- Mutex(Lock)와 Condition Variables를 가지고 있는 Synchronization 메커니즘이다.
- 데이터에 모니터를 결합하면 하나의 스레드가 그 데이터를 사용하는 동안에는 다른 스레드들이 그 데이터를 사용할 수 없게 된다.
- 자바에서는 synchronized 메소드가 선언된 객체와 synchronized 블록에 의해 동기화되는 모든 객체에 고유한 모니터가 결합되어 동기화 작업을 수행하게 된다.
- 프레임워크나 라이브러리 그 자체에서 제공되므로 가볍고 빠르다.

```
뮤텍스와 모니터는 상호 배제를 함으로써 임계 영역에 하나의 스레드만 들어갈 수 있다.
반면, 세마포어는 하나의 스레드만 들어가거나 혹은 여러 개의 스레드가 들어가게 할 수도 있다.
```

---

## 임계 영역(Critical Section)
- 둘 이상의 스레드가 동시에 접근해서는 안되는 공유 자원을 접근하는 코드의 일부를 말한다.
- 임계 영역에서 동기화를 진행하지 못하면 치명적인 문제가 발생.

### 임계 영역 문제를 해결하기 위한 3가지 조건

#### 1. 상호 배제(Mutual exclusion)
- 프로세스 P1이 공유 자원을 접근하는 임계 영역 코드를 수행하고 있으면 다른 프로 세스들은 공유 자원을 접근하는 임계 영역 코드를 수행할 수 없다.
- 한 순간에 하나의 스레드만 실행될 수 있다.

#### 2. 진행(Progress)
- 임계 영역에서 실행중인 프로세스가 없고 별도의 동작이 없는 프로세스들만 임계 영역 진입 후보로서 참여될 수 있다.

#### 3. 한정된 대기(Bounded Waiting)
- P1이 임계 영역에 진입 신청 후부터 받아들여질 때까지, 다른 프로세스들이 임계 영역에 진입하는 횟수는 제한이 있어야 한다.

## 세마포어, 뮤텍스 차이
- 세마포어는 뮤텍스가 될 수 있지만, 뮤텍스는 세마포어가 될 수 없다.
- 세마포어는 소유할 수 없으며, 뮤텍스는 소유할 수 있고 소유주가 그 책임을 진다.
- 뮤텍스의 경우 뮤텍스를 소유하고 있는 스레드가 이 뮤텍스를 해제할 수 있다. 하지만 세마포어는 소유하고 있지 않고 있는 다른 스레드가 세마포어를 해제할 수 있다.
- 뮤텍스는 동기화 대상이 1개일 때 사용하고 세마포어는 동기화 대상이 여러 개일때 사용한다.

```
뮤텍스와 세마포어의 목적은 특정 동기화 대상이 이미 특정 스레드나 프로세스에 의해 사용중일 경우,
다른 스레드가 해당 동기화 대상에 접근하는 것을 제한하는 것으로 동일하지만,
관리하는 동기화 대상이 몇개인가에 따라 차이가 생긴다.

두 기법 모두 완벽하지는 않다.
이 기법들을 사용하더라고 데이터 무결성을 보장할 수 없으며, 데드락이 발생할 수도 있다.
하지만 상호 배제를 위한 기본적인 기법이며 여기에 좀 더 복잡한 메커니즘을 적용해 꽤나 우아하게 동작하는 프로그램을 짤 수 있다.
```